<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Notifications</title>
</head>
<body>
  <h1>Firebase Notifications Test</h1>

  <script type="module">
    // إنشاء ملف service worker تلقائيًا (مرة واحدة فقط)
    const swCode = `
      importScripts('https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js');
      importScripts('https://www.gstatic.com/firebasejs/11.7.1/firebase-messaging.js');
      
      firebase.initializeApp({
        apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
        authDomain: "story-97cf7.firebaseapp.com",
        projectId: "story-97cf7",
        messagingSenderId: "742801388214",
        appId: "1:742801388214:web:32a305a8057b0582c5ec17"
      });

      const messaging = firebase.messaging();

      messaging.onBackgroundMessage(function(payload) {
        const notificationTitle = payload.notification.title;
        const notificationOptions = {
          body: payload.notification.body
        };
        self.registration.showNotification(notificationTitle, notificationOptions);
      });
    `;

    // إنشاء ملف SW وتسجيله
    const blob = new Blob([swCode], { type: "application/javascript" });
    const swUrl = URL.createObjectURL(blob);

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjE-2q6PONBkCin9ZN22gDp9Q8pAH9ZW8",
      authDomain: "story-97cf7.firebaseapp.com",
      projectId: "story-97cf7",
      messagingSenderId: "742801388214",
      appId: "1:742801388214:web:32a305a8057b0582c5ec17"
    };

    const app = initializeApp(firebaseConfig);
    const messaging = getMessaging(app);

    // تسجيل SW
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register(swUrl)
        .then((registration) => {
          console.log("Service Worker مسجل:", registration.scope);

          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              getToken(messaging, {
                vapidKey: "BCxH3Re5ECq5gkZTasZpF8NE9yccrbCX95jGZKkTPV3jmySks6LrD09wSVTPjRVjS1zT3OGIM5OvA4NTJJd92Mw",
                serviceWorkerRegistration: registration
              }).then((currentToken) => {
                if (currentToken) {
                  console.log("Token:", currentToken);
                  alert("تم تفعيل الإشعارات. التوكن في الكونسول.");
                } else {
                  console.log("لا يوجد توكن");
                }
              });
            } else {
              alert("تم رفض الإذن للإشعارات.");
            }
          });

          onMessage(messaging, (payload) => {
            console.log("إشعار وارد:", payload);
            alert("إشعار: " + payload.notification.title + "\n" + payload.notification.body);
          });

        }).catch((err) => {
          console.error("فشل تسجيل SW:", err);
        });
    }
  </script>
</body>
</html>
